<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer | StrokePredict</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --accent-color: #4895ef;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --text-color: #333;
            --nav-top-height: 120px;
            --nav-secondary-height: 55px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--text-color);
            padding-top: calc(var(--nav-top-height) + var(--nav-secondary-height));
        }

        .viewer-container {
            display: flex;
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            min-height: 80vh;
        }

        .annotation-sidebar {
            width: 300px;
            flex-shrink: 0;
            background-color: var(--light-color);
            padding: 1rem;
            border-right: 1px solid #e0e0e0;
        }

        .main-content {
            flex-grow: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvas-container {
            position: relative;
            width: 800px;
            height: 500px;
            border: 1px solid #e0e0e0;
            background-color: #000;
            cursor: crosshair;
            margin-bottom: 1rem;
        }

        #imageCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .crosshair-h, .crosshair-v {
            position: absolute;
            background-color: white;
            opacity: 0.7;
            pointer-events: none;
        }
        .crosshair-h {
            left: 0;
            right: 0;
            height: 1px;
        }
        .crosshair-v {
            top: 0;
            bottom: 0;
            width: 1px;
        }
        
        /* --- CHANGE START: Style for the visibility toggle button --- */
        .class-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }

        .visibility-toggle {
            cursor: pointer;
            color: var(--primary-color);
        }
        /* --- CHANGE END --- */

    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container-fluid">
        <div class="viewer-container">
            <div class="annotation-sidebar">
                <h3 class="mb-3">Annotations</h3>
                <div class="annotation-tab-container">
                    <div class="annotation-tab active">Classes</div>
                </div>
                <div class="class-list">
                    <!-- --- CHANGE START: Added a container and button for the class item --- -->
                    <div class="class-item">
                        <div>
                           <span style="display:inline-block; width:15px; height:15px; background-color:#FFD700; margin-right:10px;"></span>
                           <span>Stroke</span>
                        </div>
                        <i class="fas fa-eye visibility-toggle" id="toggle-stroke-visibility"></i>
                    </div>
                    <!-- --- CHANGE END --- -->
                </div>

                <h3 class="mt-4 mb-3">Tags</h3>
                <div class="alert alert-info">
                    No Tags Applied<br>
                    Type and select tags below to add them to the image.
                </div>
            </div>

            <div class="main-content">
                <div class="d-flex justify-content-between w-100 mb-3 align-items-center" style="max-width: 800px;">
                    <h1 class="mb-0 h4">Case #{{ detection.id }}</h1>
                    <span class="badge {% if 'No' in detection.prediction_text %}bg-success{% else %}bg-danger{% endif %}">{{ detection.prediction_text }}</span>
                </div>
                <div class="canvas-container">
                    <canvas id="imageCanvas"></canvas>
                    <div class="crosshair-h" id="crosshair-h" style="opacity: 0;"></div>
                    <div class="crosshair-v" id="crosshair-v" style="opacity: 0;"></div>
                </div>
                <div class="mt-3 text-center">
                    <span class="badge bg-secondary">Confidence: {{ "%.2f"|format(detection.confidence * 100) }}%</span>
                </div>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('imageCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            const canvasContainer = document.querySelector('.canvas-container');
            const crosshairH = document.getElementById('crosshair-h');
            const crosshairV = document.getElementById('crosshair-v');
            const visibilityToggle = document.getElementById('toggle-stroke-visibility');

            const detection = JSON.parse('{{ detection | tojson | safe }}');
            
            const rawPath = detection.image_path;
            const normalizedPath = rawPath.replace(/\\/g, '/');
            const filename = normalizedPath.substring(normalizedPath.lastIndexOf('/') + 1);
            const imagePath = `/static/uploads/${filename}`;
            
            let scale, offsetX, offsetY;
            let annotations = [];
            let areAnnotationsVisible = true;

            // --- CHANGE START: New data parsing logic ---
            // This logic now correctly parses the nested JSON structure you provided.
            if (detection.prediction_text.includes('Stroke') && detection.analysis_details && detection.analysis_details.converted) {
                try {
                    const convertedData = JSON.parse(detection.analysis_details.converted);
                    if (convertedData.boxes) {
                        annotations = convertedData.boxes;
                    }
                } catch (e) {
                    console.error("Could not parse annotation data:", e);
                }
            }
            // --- CHANGE END ---

            img.onload = function() {
                redrawCanvas();
            };
            
            img.src = imagePath;

            function redrawCanvas() {
                if (!img.complete || img.naturalWidth === 0) return;

                const containerWidth = canvasContainer.offsetWidth;
                const containerHeight = canvasContainer.offsetHeight;

                canvas.width = containerWidth;
                canvas.height = containerHeight;

                scale = Math.min(containerWidth / img.width, containerHeight / img.height);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;

                offsetX = (containerWidth - scaledWidth) / 2;
                offsetY = (containerHeight - scaledHeight) / 2;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);
            }

            function drawAnnotationsOnHover(mouseX, mouseY) {
                redrawCanvas(); // Redraw base image first

                if (!areAnnotationsVisible) return; // Exit if annotations are hidden

                annotations.forEach(box => {
                    // Coordinates from your data might be strings, so we parse them
                    const rectX = parseFloat(box.x) * scale + offsetX;
                    const rectY = parseFloat(box.y) * scale + offsetY;
                    const rectWidth = parseFloat(box.width) * scale;
                    const rectHeight = parseFloat(box.height) * scale;

                    if (mouseX > rectX && mouseX < rectX + rectWidth && mouseY > rectY && mouseY < rectY + rectHeight) {
                        ctx.strokeStyle = '#FFD700';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(rectX, rectY, rectWidth, rectHeight);

                        ctx.fillStyle = '#FFD700';
                        const text = `Stroke`;
                        const textMetrics = ctx.measureText(text);
                        ctx.fillRect(rectX, rectY, textMetrics.width + 8, 20);
                        
                        ctx.fillStyle = '#000000';
                        ctx.font = '14px Arial';
                        ctx.fillText(text, rectX + 4, rectY + 14);
                    }
                });
            }

            // --- CHANGE START: Event listener for the eye icon ---
            visibilityToggle.addEventListener('click', function() {
                areAnnotationsVisible = !areAnnotationsVisible; // Toggle the state
                this.classList.toggle('fa-eye');
                this.classList.toggle('fa-eye-slash');
                
                // If we are hiding annotations, redraw the canvas to clear any visible box
                if (!areAnnotationsVisible) {
                    redrawCanvas();
                }
            });
            // --- CHANGE END ---

            canvasContainer.addEventListener('mousemove', function(e) {
                const rect = canvasContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                crosshairH.style.top = `${y}px`;
                crosshairV.style.left = `${x}px`;

                if (img.complete) {
                    drawAnnotationsOnHover(x, y);
                }
            });

            canvasContainer.addEventListener('mouseleave', () => {
                crosshairH.style.opacity = 0;
                crosshairV.style.opacity = 0;
                if (img.complete) {
                    redrawCanvas(); // Clear annotations when mouse leaves
                }
            });

            canvasContainer.addEventListener('mouseenter', () => {
                crosshairH.style.opacity = 0.7;
                crosshairV.style.opacity = 0.7;
            });

            window.addEventListener('resize', redrawCanvas); // Redraw on window resize
        });
    </script>
</body>
</html>
